name: build

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/build.yml
      - src/**
      - src-tauri/**
      - package.json
      - bun.lock
  pull_request:
  workflow_call:
    inputs:
      version:
        description: Version tag for release packaging
        required: false
        type: string
      sign:
        description: Enable signing (requires release env & secrets)
        required: false
        type: boolean
        default: false
    secrets:
      GPG_PRIVATE_KEY:
        description: GPG private key for signing packages
        required: false
      GPG_PASSPHRASE:
        description: Passphrase for the GPG key
        required: false
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  linux:
    runs-on: ubuntu-24.04
    # Only signed builds use the 'release' environment (and its secrets)
    environment: ${{ inputs.sign && 'release' || '' }}
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libvulkan-dev \
            glslc

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Rust stable
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
        with:
          cache: ${{ !startsWith(github.ref, 'refs/tags/') }}

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      - name: Import GPG key
        if: ${{ inputs.sign }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Build Tauri app (unsigned)
        if: ${{ !inputs.sign }}
        run: bun run tauri build

      - name: Build Tauri app (signed)
        if: ${{ inputs.sign }}
        env:
          # AppImage signing (only when sign=true)
          SIGN: "1"
          SIGN_KEY: "C08D335E8E763F5DE980FA12E796EC7D2E9F27A3"
          APPIMAGETOOL_SIGN_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          APPIMAGETOOL_FORCE_SIGN: "1"
          # RPM signing (only when sign=true)
          TAURI_SIGNING_RPM_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          TAURI_SIGNING_RPM_KEY_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: bun run tauri build

      - name: Create tarball
        working-directory: src-tauri/target/release
        env:
          VERSION: ${{ inputs.version || 'dev' }}
        run: |
          tar czf bundle/dashtext-${VERSION}-linux-x86_64.tar.gz dashtext

      - name: Generate checksums
        working-directory: src-tauri/target/release/bundle
        run: |
          for f in deb/*.deb; do sha256sum "$f" > "$f.sha256"; done
          for f in appimage/*.AppImage; do sha256sum "$f" > "$f.sha256"; done
          for f in rpm/*.rpm; do sha256sum "$f" > "$f.sha256"; done
          for f in *.tar.gz; do sha256sum "$f" > "$f.sha256"; done

      - name: Upload deb
        uses: actions/upload-artifact@v5
        with:
          name: bundle-deb
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/deb/*.sha256

      - name: Upload AppImage
        uses: actions/upload-artifact@v5
        with:
          name: bundle-appimage
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/*.sha256

      - name: Upload rpm
        uses: actions/upload-artifact@v5
        with:
          name: bundle-rpm
          path: |
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/rpm/*.sha256

      - name: Upload tar.gz
        uses: actions/upload-artifact@v5
        with:
          name: bundle-tar
          path: |
            src-tauri/target/release/bundle/*.tar.gz
            src-tauri/target/release/bundle/*.sha256

  attest:
    runs-on: ubuntu-24.04
    if: ${{ inputs.version != '' }}
    needs: [linux]
    permissions:
      id-token: write
      attestations: write
    steps:
      - uses: actions/download-artifact@v6

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            bundle-deb/*
            bundle-appimage/*
            bundle-rpm/*
            bundle-tar/*
